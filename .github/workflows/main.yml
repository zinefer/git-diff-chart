name: Publish to npm

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
      
      - name: Check if src or version changed
        id: check_changes
        run: |
          set -e
          
          # Ensure we have at least 2 commits to compare
          if ! git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "Not enough commit history. Proceeding with publish."
            echo "SKIP_PUBLISH=false" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # Get the previous commit on main
          PREV_COMMIT=$(git rev-parse HEAD^)
          
          # Check if src/ changed (boolean)
          if git diff --name-only $PREV_COMMIT HEAD | grep -q '^src/'; then
            SRC_CHANGED="true"
          else
            SRC_CHANGED="false"
          fi
          
          # Get previous and current version
          PREV_VERSION=$(git show $PREV_COMMIT:package.json | jq -r .version 2>/dev/null || echo "unknown")
          CUR_VERSION=$(jq -r .version package.json 2>/dev/null || echo "unknown")
          
          # If src changed but version did not, fail
          if [[ "$SRC_CHANGED" == "true" && "$PREV_VERSION" == "$CUR_VERSION" && "$PREV_VERSION" != "unknown" ]]; then
            echo "Error: src/ changed but version did not change. Please bump the version in package.json."
            echo "Previous version: $PREV_VERSION"
            echo "Current version: $CUR_VERSION"
            exit 1
          fi
          
          # If src did not change, skip publish
          if [[ "$SRC_CHANGED" == "false" ]]; then
            echo "No changes in src/. Skipping publish."
            echo "SKIP_PUBLISH=true" >> "$GITHUB_ENV"
          else
            echo "Source changes detected. Proceeding with publish."
            echo "SKIP_PUBLISH=false" >> "$GITHUB_ENV"
          fi
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build the project
        run: npm run build
      
      - name: Run tests
        run: npm test
      
      - name: Run e2e tests
        run: npm run test:e2e
      
      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        if: env.SKIP_PUBLISH != 'true'
        run: npm publish --access public